// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  // Personal Suite relations
  portfolioItems    PortfolioItem[]
  drawings          Drawing[]
  drawingFolders    DrawingFolder[]
  libraries         ExcalidrawLibrary[]
  trackedProducts   TrackedProduct[]
  supermarkets      UserSupermarket[]
  comparisonGroups  ComparisonGroup[]
  location          UserLocation?
  notionConnection  NotionConnection?
  revenueEntries    RevenueEntry[]
  costEntries       CostEntry[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===== PORTFOLIO TRACKER =====
model PortfolioItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isin      String
  symbol    String
  name      String
  exchange  String
  currency  String
  createdAt DateTime @default(now())

  @@unique([userId, isin])
  @@index([userId])
}

// ===== EXCALIDRAW =====
model DrawingFolder {
  id        String          @id @default(cuid())
  name      String
  parentId  String?
  parent    DrawingFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  DrawingFolder[] @relation("FolderHierarchy")
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  drawings  Drawing[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([userId])
  @@index([parentId])
}

model Drawing {
  id        String         @id @default(cuid())
  name      String
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  folderId  String?
  folder    DrawingFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  elements  Json
  appState  Json?
  files     DrawingFile[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([userId])
  @@index([folderId])
}

model DrawingFile {
  id        String   @id @default(cuid())
  fileId    String
  drawingId String
  drawing   Drawing  @relation(fields: [drawingId], references: [id], onDelete: Cascade)
  mimeType  String
  dataUrl   String   @db.Text
  createdAt DateTime @default(now())

  @@unique([drawingId, fileId])
}

model ExcalidrawLibrary {
  id        String   @id @default(cuid())
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     Json // LibraryItems array from Excalidraw
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
}

// ===== PERSONAL SHOPPER =====
model Supermarket {
  id       String    @id @default(cuid())
  name     String    @unique
  url      String?
  logoUrl  String?
  products Product[]
}

model Product {
  id            String           @id @default(cuid())
  externalId    String
  name          String
  supermarketId String
  supermarket   Supermarket      @relation(fields: [supermarketId], references: [id], onDelete: Cascade)
  category      String?
  imageUrl      String?
  currentPrice  Float
  unit          String?
  priceHistory  PriceHistory[]
  trackedBy     TrackedProduct[]
  updatedAt     DateTime         @updatedAt

  @@unique([supermarketId, externalId])
}

model PriceHistory {
  id         String   @id @default(cuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  price      Float
  recordedAt DateTime @default(now())

  @@index([productId, recordedAt])
}

model TrackedProduct {
  id                String           @id @default(cuid())
  userId            String
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId         String
  product           Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  targetPrice       Float?
  alertOnSale       Boolean          @default(true)
  isFavorite        Boolean          @default(false)
  userCategory      String?
  createdAt         DateTime         @default(now())
  comparisonGroupId String?
  comparisonGroup   ComparisonGroup? @relation(fields: [comparisonGroupId], references: [id], onDelete: SetNull)

  @@unique([userId, productId])
  @@index([comparisonGroupId])
  @@index([userId, isFavorite])
}

model ComparisonGroup {
  id        String           @id @default(cuid())
  name      String?
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  products  TrackedProduct[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([userId])
}

model UserSupermarket {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  supermarketId String
  createdAt     DateTime @default(now())

  @@unique([userId, supermarketId])
}

// ===== WEATHER =====
model UserLocation {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  city      String
  country   String
  lat       Float
  lon       Float
  updatedAt DateTime @updatedAt
}

// ===== FINANCE TRACKER =====
model NotionConnection {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  revenueDatabaseId String?
  revenueLastSyncAt DateTime?
  costsDatabaseId   String?
  costsLastSyncAt   DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model RevenueEntry {
  id             String    @id @default(cuid())
  notionPageId   String    @unique
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  description    String?
  kilometers     Float?
  minutes        Int?
  hours          Float?
  billable       Boolean   @default(true)
  startTime      DateTime?
  endTime        DateTime?
  breakMinutes   Int?
  client         String?
  type           String?
  rate           Float?
  revenue        Float?
  taxReservation Float?
  netIncome      Float?
  year           Int?
  quarter        String?
  month          String?
  monthNumber    Int?
  week           Int?
  invoiceNumber  String?
  invoiceDate    DateTime?
  invoiceStatus  String?
  clientType     String?
  syncedAt       DateTime  @default(now())

  @@index([userId])
  @@index([userId, year])
  @@index([startTime])
}

model CostEntry {
  id            String    @id @default(cuid())
  notionPageId  String    @unique
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  vat           Float?
  amountExclVat Float?
  invoiceDate   DateTime?
  year          Int?
  quarter       String?
  description   String?
  vatRemarks    String?
  vatSection    String?
  syncedAt      DateTime  @default(now())

  @@index([userId])
  @@index([userId, year])
  @@index([invoiceDate])
}
